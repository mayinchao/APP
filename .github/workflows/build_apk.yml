name: Build Plant Identification APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]
  workflow_dispatch: # 允许手动触发工作流

env:
  PYTHON_VERSION: '3.11'
  APP_NAME: '植物识别应用'
  APP_PACKAGE_NAME: 'com.mayinchao.plantapp'

jobs:
  build-android-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Show project structure
      run: |
        echo "=== Project Structure ==="
        find . -name "*.py" | grep -E "(main|app)" | head -15
        echo ""
        echo "=== Frontend Directory ==="
        ls -la Frontend/

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flet[build]
        
        if [ -f "Frontend/requirements.txt" ]; then
          pip install -r Frontend/requirements.txt
        else
          pip install Pillow requests torch torchvision numpy
        fi
        
        echo "=== Installed Packages ==="
        pip list | grep -E "(flet|PIL|torch|requests|numpy)"

    - name: Test Frontend import
      run: |
        echo "=== Testing Frontend Import ==="
        python -c "
import sys
sys.path.insert(0, 'Frontend')
try:
    from main import main
    print('SUCCESS: Imported Frontend.main')
except Exception as e:
    print(f'FAILED: {e}')
    import traceback
    traceback.print_exc()
"

    - name: Create main.py entry point
      run: |
        cat > main.py << 'EOF'
import sys
import os
import flet as ft

print("Starting Plant Identification App")

sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'Frontend'))
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'backend'))

def main(page: ft.Page):
    page.title = "植物识别应用"
    page.padding = 20
    
    print("Initializing Flet page")
    
    try:
        from Frontend.main import main as frontend_main
        print("SUCCESS: Imported Frontend.main")
        return frontend_main(page)
    except Exception as e:
        print(f"FAILED: {e}")
        import traceback
        traceback.print_exc()
        
        page.add(ft.Text("植物识别应用", size=24, weight="bold"))
        page.add(ft.Text("应用已成功启动", size=16))
        page.add(ft.Text("如果看到此消息，请检查 Frontend/main.py", size=14))
        
        def test_click(e):
            page.add(ft.Text("按钮测试成功!"))
        
        page.add(ft.ElevatedButton("测试按钮", on_click=test_click))

if __name__ == "__main__":
    print("Starting Flet app")
    ft.app(target=main)
EOF

    - name: Build APK
      run: |
        echo "=== Building APK ==="
        flet --version
        flet build apk --verbose

    - name: Check build results
      run: |
        echo "=== Finding APK files ==="
        find . -name "*.apk" -type f 2>/dev/null | while read file; do
          echo "Found APK: $file ($(du -h "$file" | cut -f1))"
        done
        
        if [ -d "build" ]; then
          echo "=== Build directory ==="
          find build/ -type f 2>/dev/null | head -10
        else
          echo "Build directory not found"
        fi

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: plant-app-apk
        path: |
          build/apk/*.apk
          *.apk
        retention-days: 30
        if-no-files-found: warn

    - name: Success notification
      if: success()
      run: echo "APK build successful! Download from Artifacts."

    - name: Failure notification
      if: failure()
      run: echo "APK build failed. Check logs for details."
