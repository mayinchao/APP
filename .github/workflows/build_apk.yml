name: Build Plant Identification APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

env:
  PYTHON_VERSION: '3.11'
  APP_NAME: 'æ¤ç‰©è¯†åˆ«åº”ç”¨'
  APP_PACKAGE_NAME: 'com.mayinchao.plantapp'

jobs:
  build-android-apk:
    name: æ„å»º Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    # æ­¥éª¤ 3: æ˜¾ç¤ºé¡¹ç›®ç»“æ„
    - name: æ˜¾ç¤ºé¡¹ç›®ç»“æ„
      run: |
        echo "=== é¡¹ç›®æ–‡ä»¶ç»“æ„ ==="
        find . -name "*.py" | grep -E "(main|app)" | head -15
        echo ""
        echo "=== Frontend ç›®å½• ==="
        ls -la Frontend/
        echo ""
        echo "=== æ£€æŸ¥ requirements.txt æ–‡ä»¶ ==="
        [ -f "Frontend/requirements.txt" ] && echo "Frontend/requirements.txt å­˜åœ¨" || echo "Frontend/requirements.txt ä¸å­˜åœ¨"
        [ -f "backend/requirements.txt" ] && echo "backend/requirements.txt å­˜åœ¨" || echo "backend/requirements.txt ä¸å­˜åœ¨"

    # æ­¥éª¤ 4: å®‰è£… Python ä¾èµ–
    - name: å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        echo "æ­£åœ¨å®‰è£… Flet å’Œæ„å»ºå·¥å…·..."
        pip install flet[build]
        
        # ä¼˜å…ˆå®‰è£… Frontend çš„ä¾èµ–
        if [ -f "Frontend/requirements.txt" ]; then
          echo "å®‰è£… Frontend/requirements.txt ä¸­çš„ä¾èµ–..."
          pip install -r Frontend/requirements.txt
        fi
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¾èµ–æ–‡ä»¶ï¼Œå®‰è£…å¸¸è§ä¾èµ–
        if [ ! -f "Frontend/requirements.txt" ] && [ ! -f "backend/requirements.txt" ]; then
          echo "å®‰è£…é»˜è®¤ä¾èµ–..."
          pip install Pillow requests torch torchvision numpy
        fi
        
        echo "=== å·²å®‰è£…çš„å…³é”®åŒ… ==="
        pip list | grep -E "(flet|PIL|torch|requests|numpy)"

    # æ­¥éª¤ 5: æµ‹è¯•å¯¼å…¥ Frontend æ¨¡å—
    - name: æµ‹è¯•å¯¼å…¥ Frontend æ¨¡å—
      run: |
        echo "=== æµ‹è¯•å¯¼å…¥ Frontend.main ==="
        python -c "
import sys
import os
sys.path.insert(0, 'Frontend')
try:
    from main import main
    print('âœ… æˆåŠŸå¯¼å…¥ Frontend.main')
    print('å‡½æ•°è¯¦æƒ…:', main)
except Exception as e:
    print(f'âŒ å¯¼å…¥å¤±è´¥: {e}')
    import traceback
    traceback.print_exc()
"

    # æ­¥éª¤ 6: åˆ›å»ºç»Ÿä¸€å…¥å£ç‚¹
    - name: åˆ›å»ºç»Ÿä¸€å…¥å£ç‚¹
      run: |
        cat > main.py << 'EOF'
import sys
import os
import flet as ft

print("=== å¯åŠ¨æ¤ç‰©è¯†åˆ«åº”ç”¨ ===")

# æ·»åŠ é¡¹ç›®è·¯å¾„
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'Frontend'))
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'backend'))

def main(page: ft.Page):
    page.title = "æ¤ç‰©è¯†åˆ«åº”ç”¨"
    page.padding = 20
    
    print("=== åˆå§‹åŒ– Flet é¡µé¢ ===")
    
    try:
        # å°è¯•å¯¼å…¥ Frontend çš„ä¸»å‡½æ•°
        from Frontend.main import main as frontend_main
        print("âœ… æˆåŠŸå¯¼å…¥ Frontend.main")
        return frontend_main(page)
    except Exception as e:
        print(f"âŒ å¯¼å…¥ Frontend.main å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        
        # åˆ›å»ºç®€å•çš„å¤‡ç”¨ç•Œé¢
        page.add(ft.Text("æ¤ç‰©è¯†åˆ«åº”ç”¨", size=24, weight="bold"))
        page.add(ft.Text("åº”ç”¨å·²æˆåŠŸå¯åŠ¨", size=16))
        page.add(ft.Text("å¦‚æœçœ‹åˆ°æ­¤æ¶ˆæ¯ï¼Œè¯·æ£€æŸ¥ Frontend/main.py çš„ä»£ç ", size=14))
        
        # æ·»åŠ ä¸€ä¸ªæµ‹è¯•æŒ‰é’®
        def test_click(e):
            page.add(ft.Text("æŒ‰é’®æµ‹è¯•æˆåŠŸ!"))
        
        page.add(ft.ElevatedButton("æµ‹è¯•æŒ‰é’®", on_click=test_click))

if __name__ == "__main__":
    print("=== å¯åŠ¨ Flet åº”ç”¨ ===")
    ft.app(target=main)
EOF
        
        echo "âœ… å·²åˆ›å»º main.py å…¥å£ç‚¹"
        echo "=== main.py å†…å®¹é¢„è§ˆ ==="
        head -20 main.py

    # æ­¥éª¤ 7: æ„å»º APK
    - name: æ„å»º APK
      run: |
        echo "=== å¼€å§‹æ„å»º APK ==="
        echo "Flet ç‰ˆæœ¬:"
        flet --version
        
        echo "=== æ‰§è¡Œæ„å»ºå‘½ä»¤ ==="
        # ä½¿ç”¨è¯¦ç»†æ¨¡å¼æ„å»º
        flet build apk --verbose
        
        echo "=== æ„å»ºå®Œæˆ ==="

    # æ­¥éª¤ 8: æ£€æŸ¥æ„å»ºç»“æœ
    - name: æ£€æŸ¥æ„å»ºç»“æœ
      run: |
        echo "=== æŸ¥æ‰¾ APK æ–‡ä»¶ ==="
        find . -name "*.apk" -type f 2>/dev/null | while read file; do
          echo "æ‰¾åˆ° APK: $file ($(du -h "$file" | cut -f1))"
        done
        
        echo "=== build ç›®å½•ç»“æ„ ==="
        if [ -d "build" ]; then
          find build/ -type f 2>/dev/null | head -20
        else
          echo "âŒ build ç›®å½•ä¸å­˜åœ¨"
        fi

    # æ­¥éª¤ 9: ä¸Šä¼  APK æ–‡ä»¶
    - name: ä¸Šä¼  APK æ„ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: æ¤ç‰©è¯†åˆ«åº”ç”¨-APK
        path: |
          build/apk/*.apk
          *.apk
        retention-days: 30
        if-no-files-found: warn
        compression-level: 0  # ä¸å‹ç¼©ï¼ŒåŠ å¿«ä¸Šä¼ ä¸‹è½½é€Ÿåº¦

    # æ­¥éª¤ 10: æ„å»ºæˆåŠŸé€šçŸ¥
    - name: æ„å»ºæˆåŠŸé€šçŸ¥
      if: success()
      run: |
        echo "ğŸ‰ APK æ„å»ºæˆåŠŸ!"
        echo "è¯·åœ¨ Artifacts åŒºåŸŸä¸‹è½½ç”Ÿæˆçš„ APK æ–‡ä»¶"

    # æ­¥éª¤ 11: æ„å»ºå¤±è´¥é€šçŸ¥
    - name: æ„å»ºå¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ APK æ„å»ºå¤±è´¥"
        echo "è¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯æ—¥å¿—"
