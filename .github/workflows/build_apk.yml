name: Build Flet Android APK

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]
  workflow_dispatch: # 允许手动触发工作流

env:
  PYTHON_VERSION: '3.11'
  APP_NAME: '我的Flet应用'  # 在此设置你的应用名称
  APP_PACKAGE_NAME: 'com.example.myapp'  # 在此设置你的应用包名

jobs:
  build-android-apk:
    name: 构建 Flet Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 设置超时时间，避免构建任务无限制运行

    steps:
    - name: 检出源代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取所有历史记录和标签，便于版本信息处理

    - name: 设置 Python 环境
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'  # 缓存 pip 依赖，加速后续构建

    - name: 安装项目依赖
      run: |
        python -m pip install --upgrade pip
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          pip install flet  # 如果项目没有requirements.txt，则默认安装flet
        fi
        # 显示已安装的包，便于调试
        echo "已安装的Python包:"
        pip list

    - name: 配置 Java 环境 (Flet Build可能需要)
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        cache: 'gradle'

    - name: 执行 Flet APK 构建
      run: |
        set -e  # 遇到错误立即退出，便于快速发现问题
        
        # 构建基础命令
        BUILD_CMD="flet build apk"
        
        # 添加构建参数
        # 应用名称和包名从环境变量读取，你可以在文件顶部env部分自定义
        BUILD_CMD="$BUILD_CMD --name \"${{ env.APP_NAME }}\""
        BUILD_CMD="$BUILD_CMD --android-package-name \"${{ env.APP_PACKAGE_NAME }}\""
        # 包含常用的第三方包，你可以根据项目需要增删
        BUILD_CMD="$BUILD_CMD --include-packages \"PIL,requests,urllib3\""
        
        # 输出最终执行的命令
        echo "执行构建命令: $BUILD_CMD"
        
        # 执行构建
        eval $BUILD_CMD

    - name: 上传 APK 构件
      uses: actions/upload-artifact@v4
      with:
        name: flet-app-apk
        path: |
          build/apk/*.apk
          *.apk
        retention-days: 30  # 设置构件保留天数

    - name: 上传 APK 到 Release (仅在创建Release时触发)
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./build/apk/*.apk  # 根据Flet构建输出路径调整
        asset_name: ${{ env.APP_NAME }}-${{ github.event.release.tag_name }}.apk
        asset_content_type: application/vnd.android.package-archive
